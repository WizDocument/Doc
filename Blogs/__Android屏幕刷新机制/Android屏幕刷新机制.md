这次就来梳理一下 Android 的屏幕刷新机制，深度不会特别深，毕竟这部分涉及的东西很多也很难；但多少会有一些干货，把我自己对于屏幕刷新这块的一个理解梳理出来，能力有限，有错的地方还望指点一下。  

# 提问环节  
阅读源码还是得带着问题或目的性的去阅读，这样阅读过程中比较有条理性，不会跟偏或太深入，所以，还是先来几个问题吧：  

大伙都清楚，Android 每隔 16.6ms 会刷新一次屏幕。  

**Q1：但是大伙想过没有，这个 16.6ms 刷新一次屏幕到底是什么意思呢？是指每隔 16.6ms 调用 onDraw() 绘制一次么？**  

**Q2：如果界面一直保持没变的话，那么还会每隔 16.6ms 刷新一次屏幕么？**  

**Q3：界面的显示其实就是一个 Activity 的 View 树里所有的 View 都进行测量、布局、绘制操作之后的结果呈现，那么如果这部分工作都完成后，屏幕会马上就刷新么？**  

**Q4：网上都说避免丢帧的方法之一是保证每次绘制界面的操作要在 16.6ms 内完成，但如果这个 16.6ms 是一个固定的频率的话，请求绘制的操作在代码里被调用的时机是不确定的啊，那么如果某次用户点击屏幕导致的界面刷新操作是在某一个 16.6ms 帧快结束的时候，那么即使这次绘制操作小于 16.6 ms，按道理不也会造成丢帧么？**  

**Q5：大伙都清楚，主线程耗时的操作会导致丢帧，但是耗时的操作为什么会导致丢帧？它是如何导致丢帧发生的？**  

本篇主要就是搞清楚这几个问题，分析的源码基本只涉及 **ViewRootImpl** 和 **Choreographer** 这两个类。  

# 源码分析  
ps:本篇分析的源码均是 android-25 版本，版本不一样，源码可能会有些许差异，大伙过的时候注意一下。  

首先，先来过一下一些基本概念，摘抄自网上文章[android屏幕刷新显示机制](http://blog.csdn.net/litefish/article/details/53939882)：  

> 在一个典型的显示系统中，一般包括CPU、GPU、display三个部分， CPU负责计算数据，把计算好数据交给GPU,GPU会对图形数据进行渲染，渲染好后放到buffer里存起来，然后display（有的文章也叫屏幕或者显示器）负责把buffer里的数据呈现到屏幕上。  

> 显示过程，简单的说就是CPU/GPU准备好数据，存入buffer，display每隔一段时间去buffer里取数据，然后显示出来。display读取的频率是固定的，比如每个16ms读一次，但是CPU/GPU写数据是完全无规律的。  

上述内容概括一下，大体意思就是说，屏幕的刷新包括三个步骤：**CPU 计算屏幕数据、GPU 进一步处理和缓存、最后 display 再将缓存中（buffer）的屏幕数据显示出来。**  

ps:开发过程中应该接触不到 GPU、display 这些层面的东西，所以我把这部分工作都称作底层的工作了，下文出现的底层指的就是除了 CPU 计算屏幕数据之外的工作。

也就是说，我们常说的 Android 每隔 16.6ms 刷新一次屏幕其实是指：**底层以固定的频率，比如每 16.6ms 将 buffer 里的屏幕数据显示出来。**  

如果还不清楚，那再看一张网上很常见的图（摘自上面同一篇文章）：  
![image.png](http://upload-images.jianshu.io/upload_images/1924341-d8ebbbd67051dd6b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

结合这张图，再来讲讲 16.6 ms 屏幕刷新一次的意思。  



